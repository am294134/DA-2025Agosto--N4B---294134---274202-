<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Menú Administrador</title>
    <link rel="stylesheet" href="/css/login.css" />
    <link rel="stylesheet" href="/css/menu-admin.css" />
    <!-- Styles moved to /css/menu-admin.css -->
  </head>
  <body class="admin">
    <div class="header">
      <h1>Panel de Administrador</h1>
      <div class="user-info">Bienvenido, <span id="nombreUsuario"></span></div>
      <button id="btn-logout" class="logout-btn" style="margin-left:12px;">Salir</button>
    </div>
    <!-- Pestañas modernas: un solo contenedor con 3 pestañas -->
    <div class="admin-sections tabs-container">
      <div class="tabs">
        <button class="tab-btn active" data-tab="tab-emular">
          Emular tránsito
        </button>
        <button class="tab-btn" data-tab="tab-bonificaciones">
          Asignar bonificaciones
        </button>
        <button class="tab-btn" data-tab="tab-cambiar-estado">
          Cambiar estado
        </button>
      </div>

      <div class="tab-contents">
        <div id="tab-emular" class="tab-panel active menu-item">
          <div class="section-header"><h3>Emular tránsito</h3></div>
          <div class="section-body">
            <p>Simula el paso de un vehículo por un peaje.</p>
            <div class="emular-layout">
              <div class="emular-form" id="emular-form-container"></div>
              <aside class="tarifas-column" aria-labelledby="tarifasHeading">
                <div id="tarifas-container"></div>
                <div id="propietario-transito-container"></div>
              </aside>
            </div>
          </div>
        </div>

        <div id="tab-bonificaciones" class="tab-panel menu-item">
          <div class="section-header"><h3>Asignar bonificaciones</h3></div>
          <div class="section-body">
            <p>Asignar bonificaciones a un propietario</p>
            <div style="display:flex;gap:20px;align-items:flex-start;">
              <div id="bonificaciones-form-container"></div>
              <div id="propietario-bonificacion-container"></div>
            </div>
          </div>
        </div>

        <div id="tab-cambiar-estado" class="tab-panel menu-item">
          <div class="section-header">
            <h3>Cambiar estado del propietario</h3>
          </div>
          <div class="section-body">
            <p>Modificar el estado actual</p>
            <div style="display:flex;gap:20px;align-items:flex-start;">
              <div id="estado-form-container"></div>
              <div id="propietario-estado-container"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script src="/utilesVista.js"></script>
    <script src="/vistaWeb.js"></script>
    <script src="/js/menu-admin.js"></script>
    <script>
      document.addEventListener("DOMContentLoaded", async function () {
        urlIniciarVista = "/acceso/iniciarAdministrador";
        urlCierreVista = "/acceso/cerrarSesion";

        await loadFragments();
        
        cargarPuestos();
        cargarBonificacionesTipos();
        initTabs();

        const btnLogout = document.getElementById('btn-logout');
        if (btnLogout) {
          btnLogout.addEventListener('click', function(e){
            e.preventDefault();
            submit('/acceso/logoutAdministrador','');
          });
        }

        // Event listener global para cambio de peaje
        document.addEventListener("change", function (e) {
          if (e.target && e.target.id === "peajeSelect") {
            const puesto = e.target.value;
            if (!puesto) {
              if (typeof mostrar_tarifasLista === 'function') mostrar_tarifasLista([]);
              const input = document.getElementById('matricula');
              if (input && input.value && input.value.trim() !== '') {
                const matricula = input.value.trim();
                submit('/emularTransito/infoMatricula', 'matricula=' + encodeURIComponent(matricula));
              }
              return;
            }
            submit('/emularTransito/tarifasPorPuesto', 'puestoId=' + encodeURIComponent(puesto));
            const input = document.getElementById('matricula');
            if (input && input.value && input.value.trim() !== '') {
              const matricula = input.value.trim();
              submit('/emularTransito/infoMatricula', 'puestoId=' + encodeURIComponent(puesto) + '&matricula=' + encodeURIComponent(matricula));
            }
          }
        });

        // Event listener global para input de matrícula
        let matriculaTimer = null;
        document.addEventListener("input", function (e) {
          if (e.target && e.target.id === "matricula") {
            clearTimeout(matriculaTimer);
            matriculaTimer = setTimeout(function () {
              const matricula = e.target.value.trim();
              const puesto = document.getElementById("peajeSelect")?.value || null;
              const infoDiv = document.getElementById("propietarioContent");
              if (!matricula) {
                if (infoDiv) infoDiv.innerHTML = "Ingrese una matrícula para ver los datos del propietario";
                return;
              }
              let data = "matricula=" + encodeURIComponent(matricula);
              if (puesto) data = "puestoId=" + encodeURIComponent(puesto) + "&" + data;
              submit("/emularTransito/infoMatricula", data);
            }, 500);
          }
        });

        // Event listener global para input de cédula en bonificaciones
        let bonPropietarioTimer = null;
        document.addEventListener("input", function (e) {
          if (e.target && e.target.id === "bon-propietario") {
            clearTimeout(bonPropietarioTimer);
            bonPropietarioTimer = setTimeout(function () {
              const ced = e.target.value.trim();
              const infoDiv = document.getElementById('bon-propietario-info');
              if (!ced) {
                if (infoDiv) infoDiv.innerHTML = 'Ingrese una cédula para ver los datos del propietario';
                window._lastPropietarioInfo = null;
                return;
              }
              const data = 'cedula=' + encodeURIComponent(ced);
              submit('/bonificaciones/infoPorCedula', data);
            }, 500);
          }
        });

        // Event listener global para input de cédula en cambiar estado
        let estadoPropietarioTimer = null;
        document.addEventListener("input", function (e) {
          if (e.target && e.target.id === "estado-propietario") {
            clearTimeout(estadoPropietarioTimer);
            estadoPropietarioTimer = setTimeout(function () {
              const ced = e.target.value.trim();
              const infoDiv = document.getElementById('estado-propietario-info');
              if (!ced) {
                if (infoDiv) infoDiv.innerHTML = 'Ingrese una cédula para ver los datos del propietario';
                window._lastPropietarioEstado = null;
                return;
              }
              const data = 'cedula=' + encodeURIComponent(ced);
              window._estadoPropietarioRequest = true;
              submit('/bonificaciones/infoPorCedula', data);
            }, 500);
          }
        });
      });

      // ===== FUNCIONES GLOBALES DE HANDLERS =====
      
      function mostrar_tarifasLista(lista) {
        const container = document.getElementById("tarifasContent");
        if (!container) return;
        if (!Array.isArray(lista) || lista.length === 0) {
          container.innerHTML = "<em>No hay tarifas para este puesto</em>";
          return;
        }
        let html = '<table class="tarifas-table"><thead><tr><th>Categoría</th><th>Monto</th></tr></thead><tbody>';
        lista.forEach((t) => {
          const categoria = t.categoria || "";
          const monto = typeof t.monto === "number" ? t.monto.toFixed(2) : t.monto;
          html += "<tr><td>" + categoria + "</td><td>" + monto + "</td></tr>";
        });
        html += "</tbody></table>";
        container.innerHTML = html;
      }

      function mostrar_infoMatricula(dto) {
        const div = document.getElementById("propietarioContent");
        if (!div) return;
        if (!dto) {
          div.innerHTML = '<div class="propietario-info notfound">No se encontró vehículo con esa matrícula.</div>';
          return;
        }
        let html = '<table class="propietario-table">';
        html += "<tr><th>Propietario</th><td>" + (dto.propietarioNombre || "") + "</td></tr>";
        html += "<tr><th>Categoría</th><td>" + (dto.categoria || "") + "</td></tr>";
        html += "<tr><th>Bonificación</th><td>" + (dto.bonificacion || "(ninguna)") + "</td></tr>";
        if (typeof dto.monto !== 'undefined' && dto.monto !== null) {
          const monto = (typeof dto.monto === 'number') ? dto.monto.toFixed(2) : dto.monto;
          html += '<tr><th>Costo del tránsito</th><td>$' + monto + '</td></tr>';
        } else {
          html += '<tr><th>Costo del tránsito</th><td><em>Seleccione un puesto para ver el costo</em></td></tr>';
        }
        if (typeof dto.saldoLuegoDelTransito !== 'undefined' && dto.saldoLuegoDelTransito !== null) {
          const saldo = (typeof dto.saldoLuegoDelTransito === 'number') ? dto.saldoLuegoDelTransito.toFixed(2) : dto.saldoLuegoDelTransito;
          html += '<tr><th>Saldo luego del tránsito</th><td>$' + saldo + '</td></tr>';
        } else {
          html += '<tr><th>Saldo luego del tránsito</th><td><em>No disponible</em></td></tr>';
        }
        html += "</table>";
        div.innerHTML = html;
      }

      function mostrar_infoPropietario(dto) {
        if (window._estadoPropietarioRequest) {
          window._estadoPropietarioRequest = false;
          const div = document.getElementById('estado-propietario-info');
          const estadoSelect = document.getElementById('estado-select');
          if (!div) return;
          if (!dto) {
            div.innerHTML = '<div class="propietario-info notfound">No se encontró propietario con esa cédula.</div>';
            return;
          }
          window._lastPropietarioEstado = dto;
          let html = '<div><strong>' + (dto.nombreCompleto || '') + '</strong>';
          if (dto.estado) {
            html += '<div>Estado actual: <strong>' + dto.estado + '</strong></div>';
            if (estadoSelect) {
              estadoSelect.value = dto.estado;
            }
          }
          html += '</div>';
          div.innerHTML = html;
          return;
        }

        const div = document.getElementById('bon-propietario-info');
        if (!div) return;
        if (!dto) {
          div.innerHTML = '<div class="propietario-info notfound">No se encontró propietario con esa cédula.</div>';
          return;
        }
        window._lastPropietarioInfo = dto;
        let html = '<div><strong>' + (dto.nombreCompleto || '') + '</strong>';
        if (dto.estado) html += '<div>Estado: ' + dto.estado + '</div>';
        html += '</div>';
        if (Array.isArray(dto.asignadas) && dto.asignadas.length > 0) {
          html += '<div style="margin-top:8px;"><strong>Bonificaciones asignadas:</strong>';
          html += '<table style="width:100%;margin-top:6px;border-collapse:collapse;">';
          html += '<thead><tr><th style="text-align:left;padding:4px;border-bottom:1px solid #ddd;">Bonificación</th><th style="text-align:left;padding:4px;border-bottom:1px solid #ddd;">Puesto</th><th style="text-align:left;padding:4px;border-bottom:1px solid #ddd;">Fecha</th></tr></thead>';
          html += '<tbody>';
          dto.asignadas.forEach(a => {
            html += '<tr>';
            html += '<td style="padding:4px;border-bottom:1px solid #f2f2f2;">' + (a.nombreBonificacion || a.nombre || '') + '</td>';
            html += '<td style="padding:4px;border-bottom:1px solid #f2f2f2;">' + (a.puesto || '') + '</td>';
            html += '<td style="padding:4px;border-bottom:1px solid #f2f2f2;">' + (a.fechaAsignada || '') + '</td>';
            html += '</tr>';
          });
          html += '</tbody></table></div>';
        } else {
          html += '<div style="margin-top:8px;font-style:italic;color:#666;">No tiene bonificaciones asignadas</div>';
        }
        div.innerHTML = html;
      }

      function mostrar_emularResultado(param) {
        const msg = (typeof param === 'string') ? param : (param && param.message) ? param.message : 'Resultado desconocido';
        try {
          if (typeof mostrarMensaje === 'function') {
            mostrarMensaje(msg);
          } else {
            alert(msg);
          }
        } catch (e) {
          alert(msg);
        }
        if (msg && msg.toLowerCase().includes('correctamente')) {
          const matricula = document.getElementById('matricula')?.value?.trim();
          const puesto = document.getElementById('peajeSelect')?.value || '';
          if (matricula) {
            let data = 'matricula=' + encodeURIComponent(matricula);
            if (puesto) data = 'puestoId=' + encodeURIComponent(puesto) + '&' + data;
            submit('/emularTransito/infoMatricula', data);
          }
        }
      }

      function mostrar_asignacionResultado(param) {
        const msg = (typeof param === 'string') ? param : (param && param.message) ? param.message : 'Resultado desconocido';
        try {
          if (typeof mostrarMensaje === 'function') {
            mostrarMensaje(msg);
          } else {
            alert(msg);
          }
        } catch (e) {
          alert(msg);
        }
        if (msg && msg.toLowerCase().includes('correctamente')) {
          const ced = window._lastRequestedCedula || document.getElementById('bon-propietario')?.value?.trim();
          if (ced) {
            submit('/bonificaciones/infoPorCedula', 'cedula=' + encodeURIComponent(ced));
          }
        }
      }

      function mostrar_cambioEstadoResultado(param) {
        const msg = (typeof param === 'string') ? param : (param && param.message) ? param.message : 'Resultado desconocido';
        try {
          if (typeof mostrarMensaje === 'function') {
            mostrarMensaje(msg);
          } else {
            alert(msg);
          }
        } catch (e) {
          alert(msg);
        }
        if (msg && msg.toLowerCase().includes('correctamente')) {
          const cedula = document.getElementById("estado-propietario")?.value?.trim();
          if (cedula) {
            window._estadoPropietarioRequest = true;
            submit('/bonificaciones/infoPorCedula', 'cedula=' + encodeURIComponent(cedula));
          }
        }
      }

      function showEmularModal(ctx) {
        let modal = document.getElementById('emularModal');
        const body = document.getElementById('emularModalBody');
        const title = document.getElementById('emularModalTitle');
        if (!modal || !body || !title) return;

        const puestoText = ctx.puestoText || ctx.puesto || '';
        const matricula = ctx.matricula || '';
        const fechaHora = ctx.fechaHora || '';

        title.textContent = 'Confirmar emulación de tránsito';
        let html = '<div>¿Desea registrar el tránsito para la matrícula <strong>' + matricula + '</strong> en el puesto <strong>' + puestoText + '</strong> en la fecha <strong>' + fechaHora + '</strong>?</div>';
        body.innerHTML = html;
        modal.style.display = 'flex';

        window._lastEmularCtx = ctx;

        const cancel = document.getElementById('emularCancelBtn');
        const confirm = document.getElementById('emularConfirmBtn');
        function doClose() {
          modal.style.display = 'none';
          cancel.removeEventListener('click', onCancel);
          confirm.removeEventListener('click', onConfirm);
        }
        function onCancel(e) { e.preventDefault(); doClose(); }
        function onConfirm(e) {
          e.preventDefault();
          confirm.disabled = true;
          const data = 'puestoId=' + encodeURIComponent(ctx.puesto || '') + '&matricula=' + encodeURIComponent(ctx.matricula || '') + '&fechaHora=' + encodeURIComponent(ctx.fechaHora || '');
          submit('/emularTransito/agregar', data);
          doClose();
          setTimeout(() => { confirm.disabled = false; }, 1500);
        }
        function onKey(e){ if(e.key === 'Escape') doClose(); }
        cancel.addEventListener('click', onCancel);
        confirm.addEventListener('click', onConfirm);
        window.addEventListener('keydown', onKey, {once:true});
      }

      function showAssignModal(ctx) {
        const modal = document.getElementById('assignModal');
        const body = document.getElementById('assignModalBody');
        const title = document.getElementById('assignModalTitle');
        if (!modal || !body) return;
        const nombreBon = ctx.tipoText || ctx.tipo || '';
        const nombrePuesto = ctx.puestoText || ctx.puesto || '';
        let propietarioHtml = '';
        if (ctx.propietario) {
          propietarioHtml = '<div><strong>' + (ctx.propietario.nombreCompleto || '') + '</strong>';
          if (ctx.propietario.estado) propietarioHtml += '<div>Estado: ' + ctx.propietario.estado + '</div>';
          propietarioHtml += '</div>';
        } else {
          propietarioHtml = '<div>Propietario: ' + (ctx.cedula || '') + '</div>';
        }
        title.textContent = 'Confirmar asignación';
        body.innerHTML = '<div>¿Desea asignar <strong>"' + nombreBon + '"</strong> en el puesto <strong>"' + nombrePuesto + '"</strong> al propietario:</div>' + propietarioHtml;
        modal.style.display = 'flex';
        window._lastRequestedCedula = ctx.cedula;
        const cancel = document.getElementById('assignCancelBtn');
        const confirm = document.getElementById('assignConfirmBtn');
        function doClose() {
          modal.style.display = 'none';
          cancel.removeEventListener('click', onCancel);
          confirm.removeEventListener('click', onConfirm);
        }
        function onCancel(e) { e.preventDefault(); doClose(); }
        function onConfirm(e) {
          e.preventDefault();
          confirm.disabled = true;
          const data = 'cedula=' + encodeURIComponent(ctx.cedula || '') + '&puesto=' + encodeURIComponent(ctx.puesto || '') + '&tipo=' + encodeURIComponent(ctx.tipo || '');
          submit('/bonificaciones/asignar', data);
          doClose();
          setTimeout(() => { confirm.disabled = false; }, 1500);
        }
        function onKey(e){ if(e.key === 'Escape') doClose(); }
        cancel.addEventListener('click', onCancel);
        confirm.addEventListener('click', onConfirm);
        window.addEventListener('keydown', onKey, {once:true});
      }

      async function loadFragments() {
        try {
          const emularForm = await fetch('/admin/emular-transito-form.html').then(r => r.text());
          document.getElementById('emular-form-container').innerHTML = emularForm;
          
          const tarifas = await fetch('/admin/tarifas-info.html').then(r => r.text());
          document.getElementById('tarifas-container').innerHTML = tarifas;

          const propietarioTransito = await fetch('/admin/propietario-info-transito.html').then(r => r.text());
          document.getElementById('propietario-transito-container').innerHTML = propietarioTransito;

          const bonificacionesForm = await fetch('/admin/asignar-bonificaciones-form.html').then(r => r.text());
          document.getElementById('bonificaciones-form-container').innerHTML = bonificacionesForm;

          const propietarioBon = await fetch('/admin/propietario-info-bonificacion.html').then(r => r.text());
          document.getElementById('propietario-bonificacion-container').innerHTML = propietarioBon;

          const estadoForm = await fetch('/admin/cambiar-estado-form.html').then(r => r.text());
          document.getElementById('estado-form-container').innerHTML = estadoForm;

          const propietarioEstado = await fetch('/admin/propietario-info-estado.html').then(r => r.text());
          document.getElementById('propietario-estado-container').innerHTML = propietarioEstado;

          // Ejecutar scripts incrustados después de cargar todos los fragmentos
          executeFragmentScripts();
        } catch (error) {
          console.error('Error cargando fragmentos:', error);
        }
      }

      function executeFragmentScripts() {
        // Re-ejecutar los scripts de los fragmentos ahora que el DOM está listo
        const scripts = document.querySelectorAll('#emular-form-container script, #tarifas-container script, #propietario-transito-container script, #bonificaciones-form-container script, #propietario-bonificacion-container script, #estado-form-container script, #propietario-estado-container script');
        scripts.forEach(oldScript => {
          const newScript = document.createElement('script');
          if (oldScript.src) {
            newScript.src = oldScript.src;
          } else {
            newScript.textContent = oldScript.textContent;
          }
          oldScript.parentNode.replaceChild(newScript, oldScript);
        });
      }

      function mostrar_datosUsuario(datos) {
        document.getElementById("nombreUsuario").textContent =
          datos.nombre + " " + datos.apellido;
      }

      function mostrar_mensaje(texto) {
        try {
          if (typeof mostrarMensaje === 'function') {
            mostrarMensaje(texto);
          } else {
            alert(texto);
          }
        } catch (e) {
          alert(texto);
        }
      }

      function mostrar_logoutExitoso(param) {
        let url = '/login-admin.html';
        if (typeof param === 'string') url = param;
        else if (param && param.parametro) url = param.parametro;
        else if (param && param.param) url = param.param;
        try {
          window.location.href = url;
        } catch (e) {
          window.location.href = '/login-admin.html';
        }
      }
    </script>
    <!-- Modal de confirmación para asignar bonificación -->
    <div id="assignModal" class="modal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.4);align-items:center;justify-content:center;z-index:2000;">
      <div class="modal-content" style="background:#fff;padding:18px;border-radius:6px;max-width:520px;margin:0 16px;">
        <h3 id="assignModalTitle">Confirmar asignación</h3>
        <div id="assignModalBody" style="margin:8px 0;line-height:1.4;color:#222;"></div>
        <div style="text-align:right;margin-top:12px;">
          <button id="assignCancelBtn" style="margin-right:8px;padding:6px 12px;">Cancelar</button>
          <button id="assignConfirmBtn" style="background:#1a73e8;color:#fff;border:none;padding:6px 12px;border-radius:4px;">Confirmar</button>
        </div>
      </div>
    </div>

    <!-- Modal de confirmación para emular tránsito -->
    <div id="emularModal" class="modal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.4);align-items:center;justify-content:center;z-index:2000;">
      <div class="modal-content" style="background:#fff;padding:18px;border-radius:6px;max-width:520px;margin:0 16px;">
        <h3 id="emularModalTitle">Confirmar emulación</h3>
        <div id="emularModalBody" style="margin:8px 0;line-height:1.4;color:#222;"></div>
        <div style="text-align:right;margin-top:12px;">
          <button id="emularCancelBtn" style="margin-right:8px;padding:6px 12px;">Cancelar</button>
          <button id="emularConfirmBtn" style="background:#1a73e8;color:#fff;border:none;padding:6px 12px;border-radius:4px;">Confirmar</button>
        </div>
      </div>
    </div>
  </body>
</html>
