<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Menú Propietario</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"
    />
    <link rel="stylesheet" href="/css/login.css" />
    <link rel="stylesheet" href="/css/menu-propietario.css" />
    <link rel="stylesheet" href="sse.js" />
  </head>
  <body class="propietario">
    <div class="header">
      <h1>Panel de Propietario</h1>
      <div class="user-info">
        Bienvenido, <span id="nombreUsuario"></span> &nbsp;|&nbsp; Estado:
        <span id="estadoUsuario"></span> &nbsp;|&nbsp; Saldo: $<span
          id="saldoUsuario"
        ></span>
        <div class="notification-icon" onclick="toggleNotifications()">
          <i class="fas fa-bell"></i>
          <span class="notification-count" id="notificationCount">0</span>
          <div class="notification-dropdown" id="notificationDropdown">
            <!-- Notifications will be inserted here -->
          </div>
        </div>
      </div>
    </div>
    <div class="page-center">
      <div class="top-row">
        <div class="left-col" id="vehiculos-container">
          <!-- Mis vehículos se cargará aquí -->
        </div>
        <div class="right-col">
          <div id="bonificaciones-container">
            <!-- Bonificaciones asignadas se cargará aquí -->
          </div>
          <div id="notificaciones-container">
            <!-- Notificaciones se cargará aquí -->
          </div>
        </div>
      </div>

      <div id="transitos-container">
        <!-- Mis tránsitos se cargará aquí -->
      </div>
    </div>

    <script src="/utilesVista.js"></script>
    <script src="/vistaWeb.js"></script>
    <script src="/js/menu-propietario.js"></script>
    <script>
      document.addEventListener("DOMContentLoaded", async function () {
        urlIniciarVista = "/acceso/iniciarPropietario";
        urlCierreVista = "/acceso/cerrarSesion";
        urlRegistroSSE = "/notificaciones/registroSSE";

        // Cargar fragmentos
        await loadFragments();

        // Cargar datos iniciales
        if (typeof cargarVehiculos === "function") cargarVehiculos();
        if (typeof cargarNotificaciones === "function") cargarNotificaciones();
        if (typeof cargarBonificaciones === "function") cargarBonificaciones();
        if (typeof cargarTransitos === "function") cargarTransitos();

        // Configurar el refresco periódico de notificaciones (cada 30 segundos)
        setInterval(() => {
          if (typeof cargarNotificaciones === "function") cargarNotificaciones();
        }, 30000);

        // Cerrar el dropdown cuando se hace click fuera de él
        document.addEventListener("click", function (event) {
          const dropdown = document.getElementById("notificationDropdown");
          const notificationIcon = document.querySelector(".notification-icon");
          if (dropdown && notificationIcon && !notificationIcon.contains(event.target) && dropdown.classList.contains("show")) {
            dropdown.classList.remove("show");
          }
        });

        // Evitar que un click dentro del dropdown lo cierre
        const dropdown = document.getElementById("notificationDropdown");
        if (dropdown) {
          dropdown.addEventListener("click", function (e) {
            e.stopPropagation();
          });
        }
      });

      async function loadFragments() {
        try {
          const vehiculos = await fetch('/propietario/mis-vehiculos.html').then(r => r.text());
          document.getElementById('vehiculos-container').innerHTML = vehiculos;

          const bonificaciones = await fetch('/propietario/bonificaciones-asignadas.html').then(r => r.text());
          document.getElementById('bonificaciones-container').innerHTML = bonificaciones;

          const notificaciones = await fetch('/propietario/notificaciones.html').then(r => r.text());
          document.getElementById('notificaciones-container').innerHTML = notificaciones;

          const transitos = await fetch('/propietario/mis-transitos.html').then(r => r.text());
          document.getElementById('transitos-container').innerHTML = transitos;

          executeFragmentScripts();
        } catch (error) {
          console.error('Error cargando fragmentos:', error);
        }
      }

      function executeFragmentScripts() {
        const scripts = document.querySelectorAll('#vehiculos-container script, #bonificaciones-container script, #notificaciones-container script, #transitos-container script');
        scripts.forEach(oldScript => {
          const newScript = document.createElement('script');
          if (oldScript.src) {
            newScript.src = oldScript.src;
          } else {
            newScript.textContent = oldScript.textContent;
          }
          oldScript.parentNode.replaceChild(newScript, oldScript);
        });
      }
    </script>
    <style>
      /* Small styles to make notification pager look nicer */
      .notification-pager {
        padding: 8px 10px;
        background: #fff;
      }
      .notification-pager button {
        padding: 6px 8px;
        border-radius: 4px;
        border: 1px solid #ddd;
        background: #f7f7f7;
        cursor: pointer;
      }
      .notification-pager button:disabled {
        opacity: 0.5;
        cursor: default;
      }
      .notification-pager .page-btn.active {
        background: #1a73e8;
        color: #fff;
        border-color: #1666c1;
      }
      .notification-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 10px;
        border-bottom: 1px solid #eee;
      }
      .notification-header h4 {
        margin: 0;
        font-size: 1rem;
      }
      .notification-header select {
        padding: 6px;
        border-radius: 4px;
      }
      .notification-item {
        padding: 8px 10px;
        border-bottom: 1px solid #f2f2f2;
      }
      .notification-item.unread {
        background: #f0f8ff;
      }
      .notification-time {
        font-size: 0.8rem;
        color: #666;
        margin-top: 4px;
      }
      .notification-dropdown {
        min-width: 300px;
        max-width: 420px;
        max-height: 420px;
        overflow: auto;
      }
      .notification-pager {
        margin: 8px;
      }
      /* Layout for propietario menu */
      .top-row {
        display: flex;
        gap: 28px;
        align-items: flex-start;
        margin: 18px 0;
      }
      .left-col {
        flex: 1;
        min-width: 320px;
      }
      .right-col {
        width: 480px;
      }
      .table-container {
        overflow: auto;
        max-width: 100%;
      }
      .vehiculos-section,
      .bonificaciones-section,
      .transitos-section,
      .notificaciones-section {
        background: #fff;
        padding: 12px;
        border: 1px solid #eee;
        border-radius: 8px;
      }
      .vehiculos-section h2,
      .bonificaciones-section h2,
      .transitos-section h2,
      .notificaciones-section h2 {
        margin-top: 0;
        font-size: 1.05rem;
      }
      /* center page container */
      .page-center {
        max-width: 1300px;
        margin: 22px auto;
        padding: 12px;
      }
      /* table tweaks for transitos */
      .transitos-section table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.95rem;
      }
      .transitos-section th,
      .transitos-section td {
        padding: 10px 12px;
        border-bottom: 1px solid #f1f1f1;
        text-align: left;
      }
      .transitos-section th {
        background: #fbfbfb;
        font-weight: 600;
      }
      .transitos-section tr:nth-child(even) {
        background: #fafafa;
      }
      .transitos-section {
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.04);
      }
      /* pager button tweaks */
      #transitosPager button {
        margin: 0 4px;
        padding: 6px 8px;
        border-radius: 4px;
        border: 1px solid #ddd;
        background: #f7f7f7;
        cursor: pointer;
      }
      #transitosPager .page-btn.active {
        background: #1a73e8;
        color: #fff;
        border-color: #1666c1;
      }
    </style>
  </body>
</html>
